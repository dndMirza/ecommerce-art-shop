<%@ page import="java.util.Collection,                 java.util.Iterator,                 java.util.Map,                 shop.Product,                 java.text.DecimalFormat"%><jsp:useBean id='basket'             scope='session'             class='shop.Basket'/><jsp:useBean id='db'             scope='session'             class='shop.ShopDB' /><%    // Handle basket operations    boolean redirectNeeded = false;    String redirectURL = "basket.jsp";    // Handle empty basket request    String empty = request.getParameter("emptyBasket");    if (empty != null) {        basket.clearBasket();        redirectNeeded = true;    }    // Handle add item request    String addItem = request.getParameter("addItem");    if (addItem != null) {        basket.addItem(addItem);        redirectNeeded = true;    }    // Handle remove item request    String removeItem = request.getParameter("removeItem");    if (removeItem != null) {        basket.removeItem(removeItem);        redirectNeeded = true;    }    // Handle update quantity request    String updateItem = request.getParameter("updateItem");    String quantityStr = request.getParameter("quantity");    if (updateItem != null && quantityStr != null) {        try {            int quantity = Integer.parseInt(quantityStr);            basket.updateQuantity(updateItem, quantity);            redirectNeeded = true;        } catch (NumberFormatException e) {            // Invalid quantity - ignore        }    }    // Implement Post-Redirect-Get pattern to prevent double-submits on refresh    if (redirectNeeded) {        response.sendRedirect(redirectURL);        return; // Stop further processing of this page    }%><html><head>    <title>Art Gallery Shop - Your Basket</title>    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <link rel="stylesheet" href="am_styles.css">    <script type="text/javascript">        function validateForm() {            var name = document.forms["orderForm"]["name"].value;            if (name == null || name.trim() == "") {                alert("Please enter your name");                return false;            }            return true;        }        function updateQuantity(pid) {            document.getElementById("updateForm_" + pid).submit();        }    </script></head><body><div class="am_container">    <!-- Include common header -->    <jsp:include page="header.jsp" />    <h2>Your Shopping Basket</h2>    <%        Map<String, Integer> quantities = basket.getQuantities();        if (quantities.isEmpty()) {    %>    <div class="am_empty_message">        <p>Your shopping basket is currently empty.</p>        <a href="products.jsp" class="am_button">Browse Products</a>    </div>    <%    } else {    %>    <table class="am_basket_table">        <tr>            <th>Image</th>            <th>Product</th>            <th>Price</th>            <th>Quantity</th>            <th>Total</th>            <th>Action</th>        </tr>        <%            DecimalFormat df = new DecimalFormat("0.00");            for (String pid : quantities.keySet()) {                Product product = db.getProduct(pid);                int quantity = quantities.get(pid);                double priceInPounds = product.price / 100.0;        %>        <tr>            <td><img src="<%= product.thumbnail %>" alt="<%= product.title %>" class="am_thumbnail"></td>            <td><a href="viewProduct.jsp?pid=<%= product.PID %>"><%= product.title %></a></td>            <td>&pound;<%= df.format(priceInPounds) %></td>            <td>                <form id="updateForm_<%= product.PID %>" action="basket.jsp" method="get">                    <input type="hidden" name="updateItem" value="<%= product.PID %>">                    <input type="number" name="quantity" value="<%= quantity %>" min="1"                           class="am_quantity_input" onchange="updateQuantity('<%= product.PID %>')">                </form>            </td>            <td>&pound;<%= basket.getProductTotalString(product.PID) %></td>            <td>                <form action="basket.jsp" method="get">                    <input type="hidden" name="removeItem" value="<%= product.PID %>">                    <input type="submit" value="Remove" class="am_button danger">                </form>            </td>        </tr>        <%            }        %>        <tr class="am_total_row">            <td colspan="4" align="right">Total:</td>            <td>&pound;<%= basket.getTotalString() %></td>            <td></td>        </tr>    </table>    <div class="am_action_buttons">        <form name="orderForm" action="order.jsp" method="post" onsubmit="return validateForm()" style="margin-right: 10px;">            <label for="customer_name">Your Name:</label>            <input type="text" id="customer_name" name="name" class="am_name_input">            <input type="submit" value="Place Order" class="am_button primary">        </form>        <form action="basket.jsp" method="get">            <input type="hidden" name="emptyBasket" value="yes">            <input type="submit" value="Empty Basket" class="am_button danger">        </form>    </div>    <%        }    %>    <div style="margin-top: 20px;">        <a href="products.jsp" class="am_button">Continue Shopping</a>    </div></div></body></html>